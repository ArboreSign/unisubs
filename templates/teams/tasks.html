{% extends "teams/base.html" %}
{% load to_json i18n teams_tags paginator doorman media_compressor verbatim_templatetag query_string utils_tags %}

{% block css %}
    {{ block.super }}
    {% include_bundle "widget-css"%}
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {% include "utils/chosenify.html" %}
    {% include_bundle "js-teams-tasks-panel" %}
    {% include_bundle "unisubs-offsite-compiled" %}
    <script src="{% url teams:rpc_api %}" type="text/javascript"></script>

    <script type="text/javascript">
        unisubs.widget.WidgetController.makeGeneralSettings({{ widget_settings|to_json|safe }});
    </script>
{% endblock %}

{% block title %}
    {{ team }} {% trans 'Tasks' %} | Universal Subtitles
{% endblock %}

{% block view_content %}

    {% with "tasks" as current %}
        {% include "teams/_tabs.html" %}
    {% endwith %}

    <div class="panel-holder view grid_9 alpha">
        {% if team|can_add_tasks:user and filters.team_video != None %}
            <div class="tools">
                <a class="button" href="{% url teams:create_task slug=team.slug team_video_pk=request.GET.team_video %}">Add Task</a>
            </div>
        {% endif %}

        {% if filters.assignee or filters.team_video or filters.language %}
        <p class="active-filters">Showing
            {% if filters.assignee == 'none' %}
                <strong>unassigned</strong>
            {% endif %}
            {% if filters.type %}
                <strong>{{ filters.type }}</strong>
            {% endif %}
            {% if filters.language %}
                <strong>{{ filters.language|lang_name_from_code }}</strong> language {% endif %}
            tasks
            {% if filters.team_video %}
                for <strong>{{ filters.team_video }}</strong>
            {% endif %}
            {% if filters.assignee and filters.assignee != 'none' %}
                assigned to <strong>{{ filters.assignee }}</strong>
            {% endif %}
        </p>
        {% endif %}

        <ul class="tasks listing">
            {% for task in tasks %}
                <li>
                    <h3>
                        {% if task.type == "Subtitle" %}
                            Subtitle:
                        {% endif %}
                        {% if task.type == "Translate" %}
                            Translate to {{ task.language_display }}:
                        {% endif %}
                        {% if task.type == "Review" %}
                            Review {{ task.language_display }}:
                        {% endif %}
                        {% if task.type == "Approve" %}
                            Approve {{ task.language_display }}:
                        {% endif %}

                        <a href="{{ task.team_video_url }}">{{ task.team_video_display }}</a>
                        <span class="descriptor">
                            {{ task.type }}
                        </span>
                        {% if task.ghost %}
                            <span class="descriptor">GHOST</span>
                        {% endif %}

                        {% if task.completed %}
                            <span class="descriptor">COMPLETED</span>
                        {% endif %}
                    </h3>
                    <p class="done">
                        <span>
                            Status:
                            {% if not task.assignee %}
                                Awaiting assignment.
                            {% else %}
                                In-progress.
                            {% endif %}
                        </span>

                        {{ stepDisplay }}
                    </p>
                    <ul class="actions">
                        <li>
                            {% if task.assignee_display %}
                                Assigned to {{ task.assignee_display }}
                            {% endif %}

                            {% if task.perform_allowed and task.assignee == request.user.id %}
                                {% if task.type == "Subtitle" or task.type == "Translate"%}
                                    <a class="perform perform-task-{{ task.pk }}" href="">Perform Task</a>

                                    <script type="text/javascript">
                                        $('.perform-task-{{ task.pk }}').click(function() {
                                            var videoSource = unisubs.player.MediaSource.videoSourceForURL('{{ task.video_url }}');
                                            var opener = new unisubs.widget.SubtitleDialogOpener( '{{ task.video_id }}', '{{ task.video_url }}', 
                                                videoSource, null, null
                                            );
                                            opener.showStartDialog();

                                            return false;
                                        });
                                    </script>
                                {% else %}
                                    <a class="perform" href="{{ task.widget_url }}">Perform Task</a>
                                {% endif %}
                            {% endif %}
                        </li>
                    </ul>

                    {% if task.delete_allowed or task.assign_allowed %}
                    <ul class="admin-controls">
                        {% if task.assign_allowed %}
                        <li>
                            <a class="action-assign" href="#">
                                {% if task.assignee_display %}
                                    Reassign
                                {% else %}
                                    Assign
                                {% endif %}
                            </a>
                        </li>
                        {% endif %}
                        {% if task.delete_allowed %}
                        <li>
                            <form action="{% url teams:delete_task slug=team.slug %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}{% query_string request.GET %}" />

                                {% if task.ghost %}
                                    <input type="hidden" name="is_ghost" value="1" />
                                    <input type="hidden" name="team_video" value="{{ task.team_video }}" />
                                    <input type="hidden" name="language" value="{{ task.language }}" />
                                {% else %}
                                    <input type="hidden" name="task" value="{{ task.pk }}" />
                                    <input type="hidden" name="is_ghost" value="" />
                                {% endif %}
                                <a class="action-delete" href="{% url teams:delete_task slug=team.slug %}">Remove</a>
                            </form>
                        </li>
                        {% endif %}
                    </ul>
                    {% endif %}
                    {% if task.assign_allowed %}
                        <form class="assign-form" action="{% url teams:assign_task slug=team.slug %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="next" value="{{ request.path }}{% query_string request.GET %}" />

                            {% if task.ghost %}
                                <input type="hidden" name="is_ghost" value="1" />
                                <input type="hidden" name="team_video" value="{{ task.team_video }}" />
                                <input type="hidden" name="language" value="{{ task.language }}" />
                            {% else %}
                                <input type="hidden" name="task" value="{{ task.pk }}" />
                                <input type="hidden" name="is_ghost" value="" />
                            {% endif %}

                            <div class="assignee-choice" style="display: none;">
                                <a class="cancel" href="#">Cancel</a>
                                <div class="member-ajax-chosen">
                                    <select name="assignee">
                                        <option value="">-----</option>
                                        <option value="">Begin typing to search.</option>
                                    </select>
                                </div>
                                <a class="button action-assign-submit" href="{% url teams:assign_task slug=team.slug %}">Assign to User</a>
                            </div>
                        </form>
                    {% endif %}
                </li>
            {% empty %}
                <li class="empty">Sorry, no tasks here.</li>
            {% endfor %}
        </ul>

        {% if is_paginated %}{% paginator %}{% endif %}
    </div>

    <div class="controls grid_3 omega">
        <form id="tasks_type_filter">
            <ul class="types">
                <li class="type {% if not request.GET.type %}current{% endif %}">
                    <a href="{{ request.path }}{% query_string request.GET type="" %}">
                        {% trans "All Pending" %}
                        <span class="all">{{ category_counts.all }}</span>
                    </a>
                </li>
                <li class="type {% if request.GET.type == "Subtitle" %}current{% endif %}">
                    <a href="{% query_string request.GET type="Subtitle" %}">
                        {% trans "Subtitle" %}
                        <span class="subtitle">{{ category_counts.subtitle }}</span>
                    </a>
                </li>
                <li class="type {% if request.GET.type == "Translate" %}current{% endif %}">
                    <a href="{% query_string request.GET type="Translate" %}">
                        {% trans "Translate" %}
                        <span class="translate">{{ category_counts.translate }}</span>
                    </a>
                </li>
                <li class="type {% if request.GET.type == "Review" %}current{% endif %}">
                    <a href="{% query_string request.GET type="Review" %}">
                        {% trans "Review" %}
                        <span class="review">{{ category_counts.review }}</span>
                    </a>
                </li>
                <li class="type {% if request.GET.type == "Approve" %}current{% endif %}">
                    <a href="{% query_string request.GET type="Approve" %}">
                        {% trans "Approve" %}
                        <span class="approve">{{ category_counts.approve }}</span>
                    </a>
                </li>
            </ul>
        </form>

        <div class="refine">
            <h4>Refine</h4>

            <form action="" method="get">
                <select id="id_task_language" name="language" class="lang-filter chosen">
                    <option value="{{ request.path }}{% query_string request.GET lang="" %}">All Languages</option>
                    {% for language in languages %}
                        <option value="{% query_string request.GET lang=language.code %}"
                            {% if request.GET.lang == language.code %}
                                selected="selected" 
                            {% endif %}>
                            {{ language.name }}
                        </option>
                    {% endfor %}
                </select>
            </form>

            <form action="" method="get">
                <select name="assignee" class="assignee-filter">
                    <option value="{{ request.path }}{% query_string request.GET assignee="" %}" {% if not request.GET.assignee %}selected="selected"{% endif %}>All Assignees</option>
                    <option value="{% query_string request.GET assignee="me" %}" {% if request.GET.assignee == "me" %}selected="selected"{% endif %}>Assigned to me</option>
                    <option value="{% query_string request.GET assignee="none" %}" {% if request.GET.assignee == "none" %}selected="selected"{% endif %}>Unassigned</option>
                </select>
            </form>
        </div>

        {% include "teams/_actions.html" %}
    </div>

    <script type="text/javascript">
        $(function() {

            $('select.lang-filter, select.assignee-filter', '.controls').change(function(e) {
                var url = $(this).children('option:selected').attr('value');
                window.location = url;
            });

            $('a.action-assign').click(function(e) {
                $('div.assignee-choice').hide();
                $(e.target).parents('.admin-controls')
                           .siblings('form.assign-form')
                               .children('div.assignee-choice')
                                   .fadeIn('fast')
                                   .find('.chzn-container')
                                       .css('width', '100%');
                return false;
            });
            $('.assignee-choice a.cancel').click(function(e) {
                $(e.target).parents('.assignee-choice').fadeOut('fast');
                return false;
            });

            $('a.action-assign-submit, a.action-delete').click(function(e) {
                $(e.target).closest('form').submit();
                return false;
            });

            $("div.member-ajax-chosen select", ".v1 .content").ajaxChosen({
                method: 'GET',
                url: '/en/teams/{{ team.slug }}/members/search/',
                dataType: 'json'
            }, function (data) {
                var terms = {};

                $.each(data.results, function (i, val) {
                    terms[data.results[i][0]] = data.results[i][1];
                });

                return terms;
            });
        });
    </script>

    <script id="IMAGE_PRELOADER" type="text/html">
        <img class="placeholder" width="256" height1="30" src="{{ STATIC_URL }}images/ajax-loader.gif"/>
    </script>
{% endblock %}
