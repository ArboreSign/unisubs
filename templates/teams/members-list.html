{% extends "teams/base.html" %}

{% load i18n query_string utils_tags teams_tags paginator widget media_compressor verbatim_templatetag %}

{% block title %}
    {{ team }} | Universal Subtitles
{% endblock %}

{% block body_attrs %}id="teams" class="v1"{% endblock %}

{% block css %}
    {{ block.super }}
    {% include_bundle "widget-css"%}
    {% include_bundle "css-teams-settings-panel"%}
{% endblock %}

{% block scripts %}
    {% include "utils/chosenify.html" %}
    {{ block.super }}
    {% if assignable_roles %}
        {% include_bundle "js-teams" %}
    {% endif %}
    <script src="{% url teams:rpc_api %}" type="text/javascript"></script>
    <script type="text/javascript">
        $(function() {
            $select = $("select#lang-filter", ".controls");
            $select.change(function(e) {
                window.location = $(this).children('option:selected').attr('value');
            });
        });
    </script>
    <script src="{{ STATIC_URL }}js/unisubs.modal.js" type="text/javascript"></script>
{% endblock %}

{% block view_content %}

    {% with "members" as current %}
        {% include "teams/_tabs.html" %}
    {% endwith %}

    {% if team.video %}
        {% widget widget_params %}
    {% endif %}

    <div class="view grid_9 alpha">

        {% if team|can_invite_to_team:user %}
            <div class="tools group">
                <a href="{% url teams:invite_members slug=team.slug %}" class="button">Invite Members</a>
            </div>
        {% endif %}

        {% if filtered %}
            <p class="active-filters">
                    Showing 
                    {% if role %}
                         <strong>{{ role }}</strong>
                    {% endif %}
                    members
                    {% if request.GET.q %}
                        matching <strong>&ldquo;{{ request.GET.q }}&rdquo;</strong>
                    {% endif %}
                    {% if request.GET.lang %}
                        speaking <strong>{{ request.GET.lang|lang_name_from_code }}</strong>
                    {% endif %}
                <a href="{% url teams:detail_members team.slug %}" class="clear-filters">Clear all filters</a>
            </p>
        {% endif %}


        {% if team_member_list|length == 0 %}
            <p class="empty">{% trans "Sorry, no members found." %}</p>
        {% endif %}

        <ul class="members listing">
            {% for member in team_member_list %}
                {% with member.pk as mpk%}
                    <li>
                        <h3>
                            <a href="{{ member.user.get_absolute_url }}">
                                {{ member.user }}
                                {% if member.user == user %}(Me){% endif %}
                            </a>
                            {% for lang in member.user.get_languages %}
                                <span class="descriptor">{{ lang.get_language_display }}</span>
                            {% endfor %}
                        </h3>
                        <p>{{ member.role|capfirst }}
                        {% if member.role == 'admin' or member.role == 'manager' %}
                            {% if member.language_narrowings_fast or member.project_narrowings_fast %}
                                {% if member.project_narrowings_fast %}for {% for narrowing in member.project_narrowings_fast %}{% if forloop.last and not forloop.first %}and {% endif %}<em>{{ narrowing.project.name }}</em>{% if not forloop.last %}, {% endif %}{% endfor %} {% trans "project" %}{{ member.project_narrowings_fast|length|pluralize }}{% if member.language_narrowings_fast %} and {% endif %}{% endif %}

                                {% if member.language_narrowings_fast %}for {% for narrowing in member.language_narrowings_fast %}{% if forloop.last and not forloop.first %}and {% endif %}<em>{{ narrowing.get_language_display }}</em>{% if not forloop.last %}, {% endif %}{% endfor %} {% trans "language" %}{{ member.language_narrowings_fast|length|pluralize }}{% endif %}
                            {% endif %}
                        {% endif %}
                        <a href="{{ member.user.get_absolute_url }}" class="thumb"><img src="{{ member.user.avatar }}" alt="{{ member.user }} avatar"></a>
                        <ul class="actions">
                            <li>
                                <a href="{% url messages:new %}?user={{ member.user.username }}">Send a message</a>
                            </li>
                        </ul>
                        {% if member in assignable_roles %}
                            <ul class="admin-controls">
                                <li>
                                    <a class="edit-role" data-team-slug="{{team.slug}}" data-member-pk="{{member.pk}}" >Edit</a>
                                </li>
                                <li>
                                <a onclick="return confirm('{% trans 'Are you sure you want to delete this team member?' %}');" href="{% url teams:remove_member slug=team.slug user_pk=member.user.pk %}" class="delete">Delete</a>
                                </li>
                            </ul>
                        {% endif %}
                    </li>
                {% endwith %}
            {% endfor %}
        </ul>
        {% if is_paginated %}{% paginator %}{% endif %}
    </div>

    <div class="controls grid_3 omega">
        {% include "teams/_filters_members.html" %}
        <div class="refine">
            <h4>{% trans "Search and Filter" %}</h4>
            {% include "teams/_search.html" %}
            <select name="lang-filter" id="lang-filter">
                <option value="">All languages</option>
                {% for code, name in languages %}
                    <option {% if request.GET.lang == code %}selected="selected"{% endif %} value="{% query_string request.GET lang=code %}">{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        {% include "teams/_actions.html" %}
    </div>

    {% if assignable_roles %}
        <script id="editRoleDialog" type="text/html">
            {% verbatim %}
            <div class="bootstrap">
                <div class="modal">
                    <div class="modal-header">
                        <a href="#" class="close action-close">x</a>
                        <h3>Edit member role</h3>
                    </div>
                    <div class="modal-body">
                        <div class="field clearfix">
                            <label for="roles">Role:</label>
                            <select class="roles" id="roles">
                                {{#roles}}
                                    <option value="{{val}}">{{name}}</option>
                                {{/roles}}
                            </select>
                        </div>
                        <div id="project-restriction" class="{{^projects}}hidden{{/projects}}">
                            <label>Project Restriction:</label>
                            <select data-placeholder="None" style="width:350px;" multiple class="chzn-select projects">
                                {{#projects}}
                                    <option {{#selected}}selected="selected"{{/selected}} value="{{pk}}">{{name}}</option>
                                {{/projects}}
                            </select>
                        </div>
                        <div id="language-restriction" class="{{^languages}}hidden{{/languages}}">
                            <label>Language Restriction:</label>
                            <select data-placeholder="None" style="width:350px;"
                                multiple class="chzn-select langs">
                                {{#languages}}
                                    <option {{#selected}}selected="selected"{{/selected}} value="{{code}}">{{name}}</option>
                                {{/languages}}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a class="btn primary action-save" >Save</a>
                        <a class="btn secondary action-close" >Cancel</a>
                    </div>
                </div>
            </div>
            {% endverbatim %}
        </script>
        <script type="text/javascript" >
            {% include "teams/panel-base.js" %}
            {% include "teams/members-panel.js" %}
        </script>
    {% endif %}

{% endblock %}
